2018-10-17 09:36:56.338 [aurora.application.session_check] [CONFIG] Session data copied to context
2018-10-17 09:36:56.338 [aurora.application.session_check] [CONFIG] Checking BM access expm.csh_prepayment_write_off_writeoffdetail_query for operation query
2018-10-17 09:36:56.341 [aurora.application.session_check] [CONFIG] Result from aurora.bm.DefaultAccessChecker$ConstantChecker@442252e5 is true
2018-10-17 09:36:56.342 [uncertain.proc] [CONFIG] [action] AccessCheck
2018-10-17 09:36:56.345 [uncertain.proc] [CONFIG] [action] CheckServiceLock
2018-10-17 09:36:56.345 [uncertain.proc] [CONFIG] [action] ParseParameter
2018-10-17 09:36:56.345 [uncertain.proc] [CONFIG] [action] ValidateInput
2018-10-17 09:36:56.345 [uncertain.proc] [CONFIG] [action] InvokeService
2018-10-17 09:36:56.345 [aurora.database] [CONFIG] ===================================== prepare to run model-query expm.csh_prepayment_write_off_writeoffdetail_query==============================
2018-10-17 09:36:56.367 [uncertain.proc] [CONFIG] [action] DecideSqlGenerationMode
2018-10-17 09:36:56.367 [uncertain.proc] [FINE] aurora.database.service.BusinessModelService.onDecideSqlGenerationMode
2018-10-17 09:36:56.367 [uncertain.proc] [CONFIG] [action] CreateOperationSql
2018-10-17 09:36:56.367 [uncertain.proc] [CONFIG] [action] PopulateOperationSql
2018-10-17 09:36:56.367 [uncertain.proc] [FINE] aurora.database.features.OrderByClauseCreator.onPopulateOperationSql
2018-10-17 09:36:56.367 [uncertain.proc] [FINE] aurora.database.features.WhereClauseCreator.onPopulateOperationSql
2018-10-17 09:36:56.367 [uncertain.proc] [CONFIG] [action] ExecuteQuery
2018-10-17 09:36:56.367 [uncertain.proc] [FINE] aurora.bm.QuerySqlCreator.onExecuteQuery
2018-10-17 09:36:56.725 [uncertain.proc] [CONFIG] [action] QueryFinish
2018-10-17 09:36:56.725 [uncertain.proc] [FINE] aurora.database.features.AutoQueryCounter.onQueryFinish
2018-10-17 09:36:56.925 [uncertain.proc] [CONFIG] [action] FetchResultSet
2018-10-17 09:36:56.925 [uncertain.proc] [FINE] aurora.database.features.CacheBasedLookUpField.postFetchResultSet
2018-10-17 09:36:56.925 [aurora.database] [CONFIG] 
============= BEGIN [query] SQL Statement execution dump ============

                SELECT
                    t.*,
                    (SELECT DISTINCT
                        m.requisition_number
                    FROM
                        csh_payment_requisition_hds m
                    WHERE
                        m.payment_requisition_header_id =
                        (SELECT
                            n.payment_requisition_header_id
                        FROM
                            csh_payment_requisition_lns n
                        WHERE
                            n.payment_requisition_line_id =
                            (SELECT
                                a.payment_requisition_line_id
                            FROM
                                csh_payment_requisition_refs a
                            WHERE
                                a.csh_transaction_line_id =
                                (SELECT
                                    b.transaction_line_id
                                FROM
                                    csh_transaction_lines b
                                WHERE
                                    b.transaction_header_id =
                                    (SELECT
                                        c.source_payment_header_id
                                    FROM
                                        CSH_TRANSACTION_HEADERS c
                                    WHERE
                                        c.transaction_header_id =
                                        (SELECT
                                            d.transaction_header_id
                                        FROM
                                            csh_transaction_lines d
                                        WHERE
                                            d.transaction_line_id = t.transaction_line_id
                                        )
                                    )
                                ) AND
                                rownum = 1
                            )
                        )
                    ) doc_number,
                    (SELECT
                        cprtv.description
                    FROM
                        csh_pay_req_types_vl cprtv
                    WHERE
                        cprtv.type_id =
                        (SELECT DISTINCT
                            m.payment_req_type_id
                        FROM
                            csh_payment_requisition_hds m
                        WHERE
                            m.payment_requisition_header_id =
                            (SELECT
                                n.payment_requisition_header_id
                            FROM
                                csh_payment_requisition_lns n
                            WHERE
                                n.payment_requisition_line_id =
                                (SELECT
                                    a.payment_requisition_line_id
                                FROM
                                    csh_payment_requisition_refs a
                                WHERE
                                    a.csh_transaction_line_id =
                                    (SELECT
                                        b.transaction_line_id
                                    FROM
                                        csh_transaction_lines b
                                    WHERE
                                        b.transaction_header_id =
                                        (SELECT
                                            c.source_payment_header_id
                                        FROM
                                            CSH_TRANSACTION_HEADERS c
                                        WHERE
                                            c.transaction_header_id =
                                            (SELECT
                                                d.transaction_header_id
                                            FROM
                                                csh_transaction_lines d
                                            WHERE
                                                d.transaction_line_id = t.transaction_line_id
                                            )
                                        )
                                    ) AND
                                    rownum = 1
                                )
                            )
                        )
                    ) type_description,
                    (SELECT DISTINCT
                        t.PAYMENT_REQUISITION_HEADER_ID
                    FROM
                        csh_payment_requisition_hds t
                    WHERE
                        t.payment_requisition_header_id =
                        (SELECT
                            l.payment_requisition_header_id
                        FROM
                            csh_payment_requisition_lns l
                        WHERE
                            l.payment_requisition_line_id =
                            (SELECT
                                a.payment_requisition_line_id
                            FROM
                                csh_payment_requisition_refs a
                            WHERE
                                a.csh_transaction_line_id =
                                (SELECT
                                    b.transaction_line_id
                                FROM
                                    csh_transaction_lines b
                                WHERE
                                    b.transaction_header_id =
                                    (SELECT
                                        c.source_payment_header_id
                                    FROM
                                        CSH_TRANSACTION_HEADERS c
                                    WHERE
                                        c.transaction_header_id =
                                        (SELECT
                                            d.transaction_header_id
                                        FROM
                                            csh_transaction_lines d
                                        WHERE
                                            d.transaction_line_id = t.transaction_line_id
                                        )
                                    )
                                ) AND
                                rownum = 1
                            )
                        )
                    ) doc_header_id
                FROM
                    (SELECT
                        '预付款核销报销单' WRITE_OFF_TYPE,
                        CTH.TRANSACTION_NUM,
                        TO_CHAR(CTH.TRANSACTION_DATE,'yyyy-mm-dd') TRANSACTION_DATE,
                        CTL.TRANSACTION_AMOUNT,
                        (CTL.TRANSACTION_AMOUNT -
                        (SELECT
                            NVL(SUM(CWO.CSH_WRITE_OFF_AMOUNT), 0)
                        FROM
                            CSH_WRITE_OFF CWO
                        WHERE
                            CWO.CSH_TRANSACTION_LINE_ID = CTL.TRANSACTION_LINE_ID AND
                            CWO.WRITE_OFF_TYPE          = 'PREPAYMENT_EXPENSE_REPORT'
                        ) -
                        (SELECT
                            NVL(SUM(CTL2.TRANSACTION_AMOUNT), 0)
                        FROM
                            CSH_TRANSACTION_HEADERS CTH1,
                            CSH_TRANSACTION_LINES CTL1,
                            CSH_TRANSACTION_HEADERS CTH2,
                            CSH_TRANSACTION_LINES CTL2
                        WHERE
                            CTL1.TRANSACTION_LINE_ID   = ctl.transaction_line_id AND
                            CTL1.TRANSACTION_HEADER_ID = CTH1.TRANSACTION_HEADER_ID AND
                            CTH2.SOURCE_HEADER_ID      = CTH1.TRANSACTION_HEADER_ID AND
                            CTH2.TRANSACTION_HEADER_ID = CTL2.TRANSACTION_HEADER_ID AND
                            CTH2.REVERSED_FLAG        IS NULL
                        )) UNWRITE_OFF_AMOUNT,
                        ers.PAYMENT_SCHEDULE_LINE_ID,
                        cth.TRANSACTION_HEADER_ID,
                        ctl.transaction_line_id
                    FROM
                        csh_transaction_headers cth,
                        csh_transaction_lines ctl,
                        exp_report_pmt_schedules ers
                    WHERE
                        cth.transaction_header_id   = ctl.transaction_header_id AND
                        --ctl.partner_category        = ers.payee_category AND
                        --ctl.partner_id              = ers.payee_id AND
                        cth.returned_flag          IN ('N','Y') AND
                        cth.reversed_flag          IS NULL AND
                        cth.company_id              =? AND
                        ctl.currency_code           =ers.currency AND
                        cth.write_off_flag         <>'C' AND
                        cth.enabled_write_off_flag  ='Y' AND
                        cth.posted_flag             = 'Y' AND
                        cth.transaction_type        ='PREPAYMENT' AND
                        ers.payment_schedule_line_id=? AND
                        (
                            ctl.transaction_amount -
                            (SELECT
                                NVL(SUM(cwo.csh_write_off_amount), 0)
                            FROM
                                csh_write_off cwo
                            WHERE
                                cwo.csh_transaction_line_id = ctl.transaction_line_id AND
                                cwo.write_off_type          = 'PREPAYMENT_EXPENSE_REPORT'
                            ) -
                            (SELECT
                                NVL(SUM(ctl2.transaction_amount), 0)
                            FROM
                                csh_transaction_headers cth1,
                                csh_transaction_lines ctl1,
                                csh_transaction_headers cth2,
                                csh_transaction_lines ctl2
                            WHERE
                                ctl1.transaction_line_id   = ctl.transaction_line_id AND
                                ctl1.transaction_header_id = cth1.transaction_header_id AND
                                cth2.source_header_id      = cth1.transaction_header_id AND
                                cth2.transaction_header_id = ctl2.transaction_header_id AND
                                cth2.reversed_flag        IS NULL
                            )
                        )
                        > 0 AND
                        (
                            (
                                (
                                    exp_report_pkg.rep_pmt_contract_exists(ers.payment_schedule_line_id) = 0 OR
                                    exp_report_pkg.csh_trx_contract_exists(ctl.transaction_line_id)      = 0
                                )
                                /* AND
                                EXISTS
                                (SELECT
                                    1
                                FROM
                                    con_cash_trx_pmt_schedule_lns cl,
                                    con_document_flows d,
                                    csh_write_off w
                                WHERE
                                    cl.csh_transaction_line_id = w.csh_transaction_line_id AND
                                    ctl.transaction_line_id    = w.source_csh_trx_line_id AND
                                    w.write_off_type           = 'PAYMENT_PREPAYMENT' AND
                                    d.document_type            = 'CON_CONTRACT' AND
                                    d.source_document_type     = 'EXP_REPORT_PMT_SCHEDULES' AND
                                    d.source_document_id       = ers.exp_report_header_id AND
                                    d.source_document_line_id  = ers.payment_schedule_line_id AND
                                    (
                                        d.document_id = cl.contract_header_id
                                    )
                                    AND
                                    (
                                        d.document_line_id = cl.payment_schedule_line_id OR
                                        (
                                            d.document_line_id          IS NULL AND
                                            cl.payment_schedule_line_id IS NULL
                                        )
                                    )
                                ) */
                            )
                            OR
                            (
                                exp_report_pkg.rep_pmt_contract_exists(ers.payment_schedule_line_id) = -1 AND
                                exp_report_pkg.csh_trx_contract_exists(ctl.transaction_line_id)      = -1
                            )
                        )
                    )t
                    --筛选同一申请人的借款单
                     WHERE EXISTS
					 (SELECT 1
					          FROM csh_payment_requisition_hds m
					         WHERE EXISTS
					         (SELECT 1
					                  FROM exp_report_headers h, exp_report_pmt_schedules ers
					                 WHERE h.exp_report_header_id = ers.exp_report_header_id
					                   AND ers.payment_schedule_line_id =
					                       t.payment_schedule_line_id
					                   AND h.employee_id = m.employee_id)
					           AND m.payment_requisition_header_id =
					               (SELECT n.payment_requisition_header_id
					                  FROM csh_payment_requisition_lns n
					                 WHERE n.payment_requisition_line_id =
					                       (SELECT a.payment_requisition_line_id
					                          FROM csh_payment_requisition_refs a
					                         WHERE a.csh_transaction_line_id =
					                               (SELECT b.transaction_line_id
					                                  FROM csh_transaction_lines b
					                                 WHERE b.transaction_header_id =
					                                       (SELECT c.source_payment_header_id
					                                          FROM csh_transaction_headers c
					                                         WHERE c.transaction_header_id =
					                                               (SELECT d.transaction_header_id
					                                                  FROM csh_transaction_lines d
					                                                 WHERE d.transaction_line_id =
					                                                       t.transaction_line_id)))
					                           AND rownum = 1)))
            
---------------------Binding info---------------------
No.1	Access path:/session/@company_id	Data type of passed value :java.lang.String	Value:835	Output:false	Database Type:null	
No.2	Access path:@payment_schedule_line_id	Data type of passed value :java.lang.String	Value:2032	Output:false	Database Type:null	

=============== END [query] SQL Statement execution dump ============

2018-10-17 09:36:56.925 [uncertain.proc] [CONFIG] [action] CreateSuccessResponse
